#pragma once

///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Macro definition
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
// Stores informations about ids. Allow Id to Type conversion
///////////////////////////////////////////////////////////////////////////
namespace xrn::ecs::component {
    template <::xrn::Id::Type id> struct IdInfo;
    template <typename T> struct IsComponent : public ::std::false_type {};
} // namespace xrn::ecs::component


///////////////////////////////////////////////////////////////////////////
/// \brief Declares a component in a namespace
///
/// Registers the type given as macro parameter as part of the components
/// of the program.
///
/// \warning Using this macro outside of the files included bellow next to
/// the base file "Ecs/Component/Declaration.hpp" leads to undefined
/// behaviors.
///
///////////////////////////////////////////////////////////////////////////
#define DECLARE_COMPONENT(namespaceName, className) \
    namespace namespaceName { class className; } \
    template <> \
    class xrn::ecs::component::declaration::detail::WithId<namespaceName::className> { \
    public: \
        [[ nodiscard ]] static inline consteval ::std::size_t getId() { return m_id; } \
    private: \
        static inline constexpr const auto m_id{ \
            __COUNTER__ - ::xrn::ecs::component::declaration::detail::baseIdCounter \
        }; \
    }; \
    template < \
    > struct xrn::ecs::component::IdInfo< \
        xrn::ecs::component::declaration::detail::WithId<namespaceName::className>::getId() \
    > { \
        using Type = namespaceName::className; \
    }; \
    template < \
    > struct xrn::ecs::component::IsComponent<namespaceName::className> : public ::std::true_type {}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Start the component declaration
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
/// Declares 'WithId' class and initializes baseIdCounter
///////////////////////////////////////////////////////////////////////////
namespace xrn::ecs::component::declaration::detail {
    template <typename> class WithId;
    static inline constexpr const ::std::size_t baseIdCounter{ __COUNTER__ + 1 };
} // namespace xrn::ecs::component::declaration::detail



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Test components (details hidden)
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
/// Declares the components used for unit testing. Can be concidered as
/// implemetation details.
///////////////////////////////////////////////////////////////////////////
#ifdef TEST
DECLARE_COMPONENT(xrn::ecs::component::test, Movable);
DECLARE_COMPONENT(xrn::ecs::component::test, Transformable);
DECLARE_COMPONENT(xrn::ecs::component::test, Transformable2d);
#endif // TEST



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// User-defined Components
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
// contains the user-defined components using the macros declared
// above.
///////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
// Ecs/Component/Declaration.hpp is the base file, but more can be added
// and included here.
///////////////////////////////////////////////////////////////////////////
#include <Ecs/Component/Declaration.hpp>



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Start the component declaration
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
/// Declares 'WithId' class and initializes baseIdCounter
///////////////////////////////////////////////////////////////////////////
namespace xrn::ecs::component::declaration::detail {
    static inline constexpr const ::std::size_t numberOfIds{
        __COUNTER__ - ::xrn::ecs::component::declaration::detail::baseIdCounter
    };
} // namespace xrn::ecs::component::declaration::detail

namespace xrn::ecs::component {
    static inline constexpr const ::xrn::Id maxId{ ::xrn::ecs::component::declaration::detail::numberOfIds };
} // namespace xrn::ecs::component

namespace xrn::ecs {
    template <typename T> using IsComponent = xrn::ecs::component::IsComponent<T>;
    template <typename T> inline constexpr bool IsComponent_v = xrn::ecs::IsComponent<T>::value;
    template <typename T> inline constexpr bool isComponent = xrn::ecs::IsComponent<T>::value;
} // namespace xrn::ecs

///////////////////////////////////////////////////////////////////////////
/// Macros undefinition
///////////////////////////////////////////////////////////////////////////
#undef DECLARE_COMPONENT
#undef DECLARE_COMPONENT
