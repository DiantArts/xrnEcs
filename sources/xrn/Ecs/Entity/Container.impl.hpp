#pragma once



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Constructors
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
::xrn::ecs::entity::Container::Container(
    ::xrn::ecs::component::Container& components
)
    : m_components{ components }
{}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Rule of 5
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
/// \brief Destructor
///
/// Clears every component of every entity.
///
///////////////////////////////////////////////////////////////////////////
::xrn::ecs::entity::Container::~Container()
{
    this->clear();
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Emplace
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent... ComponentTypes
> auto ::xrn::ecs::entity::Container::emplace()
    -> ::xrn::ecs::entity::Reference
{
    auto& entity{ m_entities.emplace_back() };
    if constexpr (sizeof...(ComponentTypes) > 0) {
        entity.addComponents<ComponentTypes...>(m_components);
    }
    return ::xrn::ecs::entity::Reference{ m_components, entity };
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent... ComponentTypes
> auto ::xrn::ecs::entity::Container::emplace(
    ComponentTypes&&... components
) -> ::xrn::ecs::entity::Reference
{
    auto& entity{ m_entities.emplace_back() };
    if constexpr (sizeof...(ComponentTypes) > 0) {
        entity.addComponents<ComponentTypes...>(
            m_components,
            ::std::forward<ComponentTypes>(components)...
        );
    }
    return ::xrn::ecs::entity::Reference{ m_components, entity };
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Remove
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
void ::xrn::ecs::entity::Container::remove(
    ::xrn::Id entityId
)
{
    auto it{ ::std::ranges::find_if(
        m_entities, [this, entityId](auto& entity){ return entity.getId() == entityId; }
    ) };
    if (it != m_entities.end()) {
        it->removeComponents(m_components);
        m_entities.erase(it);
    }
}

///////////////////////////////////////////////////////////////////////////
void ::xrn::ecs::entity::Container::remove(
    const ::xrn::ecs::entity::Reference& entityReference
)
{
    this->remove(entityReference.getId());
}

///////////////////////////////////////////////////////////////////////////
void ::xrn::ecs::entity::Container::remove(
    const ::xrn::ecs::entity::ConstReference& entityReference
)
{
    this->remove(entityReference.getId());
}

///////////////////////////////////////////////////////////////////////////
void ::xrn::ecs::entity::Container::clear()
{
    for (auto& entity : m_entities) {
        entity.removeComponents(m_components);
    }
    m_entities.clear();
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Get
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::operator[](
    ::xrn::Id entityId
) const
    -> ::xrn::ecs::entity::ConstReference
{
    auto it{ ::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
    if (it == m_entities.end()) {
        return ::xrn::ecs::entity::ConstReference{};
    }
    return ::xrn::ecs::entity::ConstReference{ *it };
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::operator[](
    ::xrn::Id entityId
) -> ::xrn::ecs::entity::Reference
{
    auto it{ ::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
    if (it == m_entities.end()) {
        return ::xrn::ecs::entity::Reference{};
    }
    return ::xrn::ecs::entity::Reference{ m_components, *it };
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::get(
    ::xrn::Id entityId
) const
    -> ::xrn::ecs::entity::ConstReference
{
    auto it{ ::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
    if (it == m_entities.end()) {
        return ::xrn::ecs::entity::ConstReference{};
    }
    return ::xrn::ecs::entity::ConstReference{ *it };
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::get(
    ::xrn::Id entityId
) -> ::xrn::ecs::entity::Reference
{
    auto it{ ::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
    if (it == m_entities.end()) {
        return ::xrn::ecs::entity::Reference{};
    }
    return ::xrn::ecs::entity::Reference{ m_components, *it };
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::unsafeGet(
    ::xrn::Id entityId
) const
    -> ::xrn::ecs::entity::ConstReference
{
    return ::xrn::ecs::entity::ConstReference{ *::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::unsafeGet(
    ::xrn::Id entityId
) -> ::xrn::ecs::entity::Reference
{
    return ::xrn::ecs::entity::Reference{ m_components, *::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) };
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// GetComponents
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    ::xrn::Id entityId
) const
    -> const ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityId);
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::Entity& entity
) const
    -> const ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entity.getId());
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::entity::Reference& entityReference
) const
    -> const ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityReference.getId());
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::entity::ConstReference& entityReference
) const
    -> const ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityReference.getId());
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    ::xrn::Id entityId
) -> ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityId);
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::Entity& entity
) -> ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entity.getId());
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::entity::Reference& entityReference
) -> ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityReference.getId());
}

///////////////////////////////////////////////////////////////////////////
template <
    ::xrn::ecs::detail::constraint::isComponent ComponentType
> auto ::xrn::ecs::entity::Container::getComponent(
    const ::xrn::ecs::entity::ConstReference& entityReference
) -> ::std::remove_cvref_t<::std::remove_pointer_t<ComponentType>>*
{
    return m_components.get<ComponentType>(entityReference.getId());
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Contains
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::contains(
    ::xrn::Id entityId
) const
    -> bool
{
    return ::std::ranges::find_if(
        m_entities,
        [entityId](const auto& entity){ return entity.getId() == entityId; }
    ) != m_entities.end();
}



///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Iterators support
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::begin()
    -> Container::Type::iterator
{
    return m_entities.begin();
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::begin() const
    -> Container::Type::const_iterator
{
    return m_entities.begin();
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::cbegin() const
    -> Container::Type::const_iterator
{
    return m_entities.cbegin();
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::end()
    -> Container::Type::iterator
{
    return m_entities.end();
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::end() const
    -> Container::Type::const_iterator
{
    return m_entities.end();
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::cend() const
    -> Container::Type::const_iterator
{
    return m_entities.cend();
}


///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////
// Component Container
//
///////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::getComponentContainer()
    -> ::xrn::ecs::component::Container&
{
    return m_components;
}

///////////////////////////////////////////////////////////////////////////
auto ::xrn::ecs::entity::Container::getComponentContainer() const
    -> const ::xrn::ecs::component::Container&
{
    return m_components;
}
